<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de Bord - Système Films & Séries</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4e73df;
            --secondary-color: #224abe;
            --success-color: #1cc88a;
            --info-color: #36b9cc;
            --warning-color: #f6c23e;
            --danger-color: #e74a3b;
            --light-bg: #f8f9fc;
        }
        
        body {
            background-color: var(--light-bg);
            font-family: 'Nunito', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        #revenueChart {
    cursor: pointer;
    }

    #revenueChart:hover {
        box-shadow: 0 0 10px rgba(78, 115, 223, 0.3);
    }

        .btn-purple {
            background-color: #6f42c1;
            border-color: #6f42c1;
            color: white;
        }

        .btn-purple:hover {
            background-color: #59359a;
            border-color: #59359a;
            color: white;
        }
        
        .stats-card {
            border-left: 4px solid;
            border-radius: 8px;
            box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            transition: transform 0.3s;
        }
        
        .stats-card:hover {
            transform: translateY(-5px);
        }
        
        .stats-card.films { border-left-color: var(--primary-color); }
        .stats-card.series { border-left-color: var(--success-color); }
        .stats-card.transactions { border-left-color: var(--info-color); }
        .stats-card.pending { border-left-color: var(--warning-color); }
        .stats-card.clients { border-left-color: var(--danger-color); }
        .stats-card.revenue { border-left-color: #6f42c1; }
        
        .card-icon {
            font-size: 2rem;
            opacity: 0.7;
        }
        
        .icon-films { color: var(--primary-color); }
        .icon-series { color: var(--success-color); }
        .icon-transactions { color: var(--info-color); }
        .icon-pending { color: var(--warning-color); }
        .icon-clients { color: var(--danger-color); }
        .icon-revenue { color: #6f42c1; }
        
        .revenue-badge {
            font-size: 0.8rem;
        }
        
        .transaction-status {
            font-size: 0.85em;
            padding: 0.35em 0.65em;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <!-- Page Heading -->
        <div class="d-sm-flex align-items-center justify-content-between mb-4">
            <h1 class="h3 mb-0 text-gray-800">Tableau de Bord Administrateur</h1>
        </div>

        <!-- Content Row -->
        <div class="row">
            <!-- Films Card -->
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card stats-card films h-100">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                    Films Disponibles</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_films }}</div>
                                <div class="mt-2 text-muted small">
                                    <i class="fas fa-sync-alt fa-sm me-1"></i>
                                    Mise à jour: {{ now.strftime('%H:%M') }}
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-film card-icon icon-films"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Series Card -->
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card stats-card series h-100">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                    Séries Disponibles</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_series }}</div>
                                <div class="mt-2 text-muted small">
                                    <span class="badge bg-info revenue-badge">
                                        {{ total_seasons }} saisons
                                    </span>
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-tv card-icon icon-series"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transactions Card -->
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card stats-card transactions h-100">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                    Transactions Total</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_transactions }}</div>
                                <div class="mt-2">
                                    <span class="badge bg-success revenue-badge me-1">
                                        {{ confirmed_transactions }} confirmées
                                    </span>
                                    <span class="badge bg-warning revenue-badge">
                                        {{ pending_transactions }} en attente
                                    </span>
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-receipt card-icon icon-transactions"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Revenue Card -->
            <div class="col-xl-3 col-md-6 mb-4">
                <div class="card stats-card revenue h-100">
                    <div class="card-body">
                        <div class="row no-gutters align-items-center">
                            <div class="col mr-2">
                                <div class="text-xs font-weight-bold text-purple text-uppercase mb-1">
                                    Revenus Totaux</div>
                                <div class="h5 mb-0 font-weight-bold text-gray-800">{{ total_revenue }} FCFA</div>
                                <div class="mt-2 text-muted small">
                                    <i class="fas fa-calendar fa-sm me-1"></i>
                                    Ce mois: {{ monthly_revenue }} FCFA
                                </div>
                            </div>
                            <div class="col-auto">
                                <i class="fas fa-dollar-sign card-icon icon-revenue"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content Row -->
        <div class="row">
            <!-- Area Chart -->
            <div class="col-xl-8 col-lg-7">
                <div class="card shadow mb-4">
                    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                        <h6 class="m-0 font-weight-bold text-primary">Revenus Mensuels</h6>
                        <div class="dropdown no-arrow">
                            <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink"
                                data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                            </a>
                            <div class="dropdown-menu dropdown-menu-right shadow animated--fade-in"
                                aria-labelledby="dropdownMenuLink">
                                <div class="dropdown-header">Options:</div>
                                <a class="dropdown-item" href="#">Exporter les données</a>
                                <a class="dropdown-item" href="#">Paramètres du graphique</a>
                                <div class="dropdown-divider"></div>
                                <a class="dropdown-item" href="#">Réinitialiser</a>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-area">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pie Chart -->
            <div class="col-xl-4 col-lg-5">
                <div class="card shadow mb-4">
                    <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                        <h6 class="m-0 font-weight-bold text-primary">Répartition des Ventes</h6>
                    </div>
                    <div class="card-body">
                        <div class="chart-pie pt-4 pb-2">
                            <canvas id="salesPieChart"></canvas>
                        </div>
                        <div class="mt-4 text-center small">
                            <span class="mr-2">
                                <i class="fas fa-circle text-primary"></i> Films
                            </span>
                            <span class="mr-2">
                                <i class="fas fa-circle text-success"></i> Séries
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Content Row -->
        <div class="row">
            <!-- Recent Transactions -->
            <div class="col-12">
                <div class="card shadow mb-4">
                    <div class="card-header py-3 d-flex justify-content-between align-items-center">
                        <h6 class="m-0 font-weight-bold text-primary">Transactions Récentes</h6>
                        <a href="{{ url_for('admin_transactions') }}" class="btn btn-sm btn-outline-primary">
                            Voir toutes les transactions
                        </a>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover" width="100%" cellspacing="0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Référence</th>
                                        <th>Client</th>
                                        <th>Produit</th>
                                        <th>Montant</th>
                                        <th>Méthode</th>
                                        <th>Statut</th>
                                        <th>Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for transaction in recent_transactions %}
                                    <tr>
                                        <td>#{{ transaction.id }}</td>
                                        <td>
                                            {% if transaction.client %}
                                                {{ transaction.client.username }}
                                                <div class="text-muted small">ID: {{ transaction.client.telegram_id }}</div>
                                            {% else %}
                                                <span class="text-muted">Client inconnu</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if transaction.film %}
                                                {{ transaction.film.title }}
                                                <div class="text-muted small">Film ({{ transaction.film.year }})</div>
                                            {% elif transaction.series and transaction.season_id %}
                                                {{ transaction.series.title }} - Saison {{ transaction.season_id }}
                                                <div class="text-muted small">Série</div>
                                            {% else %}
                                                <span class="text-muted">Produit inconnu</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ transaction.amount }} FCFA</td>
                                        <td>
                                            {% if transaction.payment_method == 'mtn_mobile' %}
                                                <span class="badge bg-info">MTN Mobile</span>
                                            {% else %}
                                                <span class="badge bg-warning text-dark">Orange Money</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if transaction.status == 'pending' %}
                                                <span class="badge bg-warning transaction-status">En attente</span>
                                            {% elif transaction.status == 'confirmed' %}
                                                <span class="badge bg-success transaction-status">Confirmée</span>
                                            {% else %}
                                                <span class="badge bg-danger transaction-status">Rejetée</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ transaction.transaction_date.strftime('%d/%m/%Y %H:%M') }}</td>
                                        <td>
                                            <div class="btn-group">
                                                {% if transaction.status == 'pending' %}
                                                    <a href="{{ url_for('confirm_transaction', transaction_id=transaction.id) }}" 
                                                       class="btn btn-sm btn-success" title="Confirmer">
                                                        <i class="fas fa-check"></i>
                                                    </a>
                                                    <a href="{{ url_for('reject_transaction', transaction_id=transaction.id) }}" 
                                                       class="btn btn-sm btn-danger" title="Rejeter">
                                                        <i class="fas fa-times"></i>
                                                    </a>
                                                {% endif %}
                                                <button class="btn btn-sm btn-info" title="Détails">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="8" class="text-center py-4">
                                            <div class="text-muted">
                                                <i class="fas fa-receipt fa-3x mb-3"></i>
                                                <p>Aucune transaction récente</p>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions Row -->
        <div class="row">
            <div class="col-lg-6 mb-4">
                <div class="card shadow">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Actions Rapides</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <a href="{{ url_for('add_film') }}" class="btn btn-success w-100 mb-2">
                                    <i class="fas fa-plus me-2"></i>Ajouter un Film
                                </a>
                            </div>
                            <div class="col-md-6 mb-3">
                                <a href="{{ url_for('add_series') }}" class="btn btn-primary w-100 mb-2">
                                    <i class="fas fa-plus me-2"></i>Ajouter une Série
                                </a>
                            </div>
                            <div class="col-md-6 mb-3">
                                <a href="{{ url_for('admin_transactions') }}" class="btn btn-info w-100 mb-2">
                                    <i class="fas fa-list me-2"></i>Voir Transactions
                                </a>
                            </div>
                            <div class="col-md-6 mb-3">
                                <a href="{{ url_for('admin_films') }}" class="btn btn-warning w-100 mb-2">
                                    <i class="fas fa-film me-2"></i>Gérer Films
                                </a>
                            </div>
                            <div class="col-md-6 mb-3">
                                <a href="{{ url_for('admin_manage_series') }}" class="btn btn-primary w-100 mb-2">
                                    <i class="fas fa-th-list fa-sm text-white-50 me-1"></i> Gérer séries
                                </a>
                            </div>
                            <div class="col-md-6 mb-3">
                                <a href="{{ url_for('create_client_account') }}" class="btn btn-purple w-100 mb-2">
                                    <i class="fas fa-user-plus me-2"></i>Générer un compte client
                                </a>
                            </div>
                            <div class="col-md-6 mb-3">
                                <a href="{{ url_for('download_report') }}" class="btn btn-success w-100 mb-2">
                                    <i class="fas fa-download fa-sm text-white-50 me-1"></i> Aide sur l'application.
                                </a>
                            </div>
                            <div class="col-md-6 mb-3">
                                <a href="{{ url_for('admin_reset_transactions') }}" class="btn btn-success w-100 mb-2" onclick="return confirm('Êtes-vous sûr de vouloir supprimer TOUTES les transactions ? Cette action est irréversible.');">
                                    <i class="fas fa-undo fa-sm text-white-50 me-1"></i> Réinitialiser les transactions
                                </a>
                            </div>
                            <div class="col-md-6 mb-3">
                                <a href="{{ url_for('admin_change_password') }}" class="btn btn-secondary w-100 mb-2">
                                    <i class="fas fa-key fa-sm text-white-50 me-1"></i> Changer le mot de passe
                                </a>
                            </div>

                            <div class="col-md-12 mb-3">
                                <a href="{{ url_for('download_data_json') }}" class="btn btn-primary w-100 mb-2">
                                    Télécharger les Films/Séries en JSON
                                </a>
                            </div>
                            
                            
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-6 mb-4">
                <div class="card shadow">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">Statistiques du Système</h6>
                    </div>
                    <div class="card-body">
                        <div class="chart-pie pt-4 pb-2">
                            <canvas id="systemStatsChart"></canvas>
                        </div>
                        <div class="mt-4 text-center small">
                            <span class="me-3">
                                <i class="fas fa-circle text-primary"></i> Films
                            </span>
                            <span class="me-3">
                                <i class="fas fa-circle text-success"></i> Séries
                            </span>
                            <span class="me-3">
                                <i class="fas fa-circle text-info"></i> Transactions
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Initialize charts
        document.addEventListener('DOMContentLoaded', function() {
            // Revenue Chart
            var ctx = document.getElementById('revenueChart').getContext('2d');
            var revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Jun', 'Jul', 'Aoû', 'Sep', 'Oct', 'Nov', 'Déc'],
                    datasets: [{
                        label: 'Revenus en FCFA',
                        data: [450000, 510000, 590000, 620000, 710000, 850000, 920000, 880000, 790000, 950000, 1100000, 1250000],
                        backgroundColor: 'rgba(78, 115, 223, 0.05)',
                        borderColor: 'rgba(78, 115, 223, 1)',
                        pointRadius: 3,
                        pointBackgroundColor: 'rgba(78, 115, 223, 1)',
                        pointBorderColor: 'rgba(78, 115, 223, 1)',
                        pointHoverRadius: 3,
                        pointHoverBackgroundColor: 'rgba(78, 115, 223, 1)',
                        pointHoverBorderColor: 'rgba(78, 115, 223, 1)',
                        pointHitRadius: 10,
                        pointBorderWidth: 2,
                        fill: true
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + ' FCFA';
                                }
                            }
                        }
                    }
                }
            });

            // Sales Pie Chart
            var pieCtx = document.getElementById('salesPieChart').getContext('2d');
            var salesPieChart = new Chart(pieCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Films', 'Séries'],
                    datasets: [{
                        data: [65, 35],
                        backgroundColor: ['#4e73df', '#1cc88a'],
                        hoverBackgroundColor: ['#2e59d9', '#17a673'],
                        hoverBorderColor: 'rgba(234, 236, 244, 1)',
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    cutout: '80%',
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // System Stats Chart
            var systemCtx = document.getElementById('systemStatsChart').getContext('2d');
            var systemStatsChart = new Chart(systemCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Films', 'Séries', 'Transactions'],
                    datasets: [{
                        data: [{{ total_films }}, {{ total_series }}, {{ total_transactions }}],
                        backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc'],
                        hoverBackgroundColor: ['#2e59d9', '#17a673', '#2c9faf'],
                        hoverBorderColor: 'rgba(234, 236, 244, 1)',
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        });

        // Confirmation for actions
        document.querySelectorAll('a[href*="confirm_transaction"], a[href*="reject_transaction"]').forEach(link => {
            link.addEventListener('click', function(e) {
                const action = this.href.includes('confirm') ? 'confirmer' : 'rejeter';
                if (!confirm(`Êtes-vous sûr de vouloir ${action} cette transaction ?`)) {
                    e.preventDefault();
                }
            });
        });


        // Rendre le graphique des revenus cliquable
        function makeChartClickable() {
            const revenueChart = Chart.getChart('revenueChart');
            if (revenueChart) {
                const canvas = document.getElementById('revenueChart');
                canvas.style.cursor = 'pointer';
                
                canvas.onclick = function(evt) {
                    const points = revenueChart.getElementsAtEventForMode(
                        evt, 
                        'nearest', 
                        { intersect: true }, 
                        true
                    );
                    
                    if (points.length) {
                        const firstPoint = points[0];
                        const month = revenueChart.data.labels[firstPoint.index];
                        const revenue = revenueChart.data.datasets[0].data[firstPoint.index];
                        
                        // Afficher les détails du mois cliqué
                        showMonthDetails(month, revenue);
                    }
                };
            }
        }

        function showMonthDetails(month, revenue) {
            // Créer une modal ou afficher les détails
            const modalHtml = `
                <div class="modal fade" id="monthDetailsModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title">Détails des revenus - ${month}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p><strong>Revenus total:</strong> ${revenue.toLocaleString()} FCFA</p>
                                <p><strong>Période:</strong> ${month} 2024</p>
                                <div class="mt-3">
                                    <button class="btn btn-outline-primary btn-sm" onclick="exportMonthData('${month}')">
                                        <i class="fas fa-download me-1"></i>Exporter les données
                                    </button>
                                    <button class="btn btn-outline-info btn-sm" onclick="viewMonthTransactions('${month}')">
                                        <i class="fas fa-list me-1"></i>Voir les transactions
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Ajouter la modal au DOM et l'afficher
            $('body').append(modalHtml);
            $('#monthDetailsModal').modal('show');
            
            // Nettoyer après fermeture
            $('#monthDetailsModal').on('hidden.bs.modal', function () {
                $(this).remove();
            });
        }

        function exportMonthData(month) {
            alert(`Export des données pour ${month} en cours...`);
            // Implémenter l'export des données
        }

        function viewMonthTransactions(month) {
            alert(`Affichage des transactions de ${month}...`);
            // Implémenter la vue des transactions par mois
        }

        // Appeler cette fonction après l'initialisation du graphique
        document.addEventListener('DOMContentLoaded', function() {
            // ... existing chart initialization code ...
            
            // Après l'initialisation du graphique des revenus
            setTimeout(makeChartClickable, 1000);
        });
    </script>
</body>
</html>